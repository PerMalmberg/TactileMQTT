<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Per's MQTT Test</title>

	<link rel="stylesheet" href="jquery-ui.min.css">
	<script src="external/jquery/jquery.js"></script>
	<script src="jquery-ui.min.js"></script>
	<script type='text/javascript' src="http://www.hivemq.com/demos/websocket-client/js/mqttws31.js"></script>


<script type='text/javascript'>//<![CDATA[ 

 //Using the HiveMQ public Broker, with a random client Id
 var client = new Messaging.Client("broker.mqttdashboard.com", 8000, "myclientid_" + parseInt(Math.random() * 100, 10));

 //Gets  called if the websocket/mqtt connection gets disconnected for any reason
 client.onConnectionLost = function (responseObject) {
     //Depending on your scenario you could implement a reconnect logic here
     alert("connection lost: " + responseObject.errorMessage);
 };

 //Gets called whenever you receive a message for your subscriptions
 client.onMessageArrived = function (message) {
     //Do something with the push message you received
     $('#myRange').slider( "option", "value", message.payloadString );
 };

 //Connect Options
 var options = {
     timeout: 3,
     //Gets Called if the connection has sucessfully been established
     onSuccess: function () {
         alert("Connected");
		 client.subscribe('motala/slider', {qos: 2});
     },
     //Gets Called if the connection could not be established
     onFailure: function (message) {
         alert("Connection failed: " + message.errorMessage);
     }
 };

 //Creates a new Messaging.Message Object and sends it to the HiveMQ MQTT Broker
 var publish = function (payload, topic, qos) {
     //Send your message (also possible to serialize it as JSON or protobuf or just use a string, no limitations)
     var message = new Messaging.Message(payload);
     message.destinationName = topic;
     message.qos = qos;
     client.send(message);
 }
//]]>  

</script>


</head>
<body>
<button onclick="publish( '2','motala/slider',2);">3. Publish 2</button>
<button onclick="publish( '40','motala/slider',2);">3. Publish 40</button>
<button onclick="client.disconnect();">(4. Disconnect)</button>
<div id="myRange"/>

<script>
$( "#myRange" ).slider( {max: 50, min: 0, value: 30});
$( "#myRange" ).on( "slidestop", function( event, ui ) { publish( "" + ui.value, 'motala/slider', 2 ); } );

client.connect(options);

</script>
  
</body>


</html>

